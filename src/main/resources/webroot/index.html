<html style="height: auto; min-height: 100%;">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Real-time carbon emission from vehicles</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- Bootstrap 3.3.7 -->
  <link rel="stylesheet" href="./assets/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="./assets/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="./assets/ionicons.min.css">
  <!-- jvectormap -->
  <link rel="stylesheet" href="./assets/jquery-jvectormap.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="./assets/AdminLTE.min.css">
  <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
  <link rel="stylesheet" href="./assets/_all-skins.min.css">
  <link rel="stylesheet" href="./assets/site.css">


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- Google Font -->
  <link rel="stylesheet" href="./assets/css">

</head>

<body class="skin-blue sidebar-mini" style="height: auto; min-height: 100%;">
  <div class="wrapper" style="height: auto; min-height: 100%;">

    <header class="main-header">
      <nav class="navbar navbar-static-top">
      </nav>
    </header>


    <div class="content-wrapper">
      <section class="content">
        <div class="row">
          <div class="col-md-8">
            
           
            <div class="row">
              <div class="col-md-6">
                <div class="box box-success">
                  <div class="box-header with-border headerStyle">
                    <h3 class="box-title">Sensor locations</h3>
                  </div>
                  <div class="box-body no-padding">
                    <div class="row">
                      <div class="col-md-12">

                        <div id="map" style="width: 100%; height: 330px;"></div>
                      </div>

                    </div>
                  </div>

                </div>
              </div>
              <div class="col-md-6">

                  <div class="box box-success">
                      <div class="box-header with-border headerStyle1">
                        <h2 class="box-title " >Air Quality Health Index: <span id="aqiindex" style="font-size: 28px; color:lightgreen">51</span>&nbsp;&nbsp; <span class="label label-warning pull-right" id="aqiStatus">Moderate</span></h2>
                      </div>
                      <div class="box-body no-padding">
                        <div class="row">
                          <div class="col-md-12">
    
                              <img src="images/AQI.jpg" style="width: 100%; height: 330px;">
                          </div>
    
                        </div>
                      </div>
    
                    </div>
              
              </div>

            </div>
            <div class="row">
                <div class="col-md-6">
                  <div class="box box-success">
                    <div class="box-header with-border headerStyle">
                      <h3 class="box-title">Humidity, Temperature & Air Quality Index</h3>
                    </div>
                    <div class="box-body no-padding">
                      <div class="row">
                        <div class="col-md-12">
                          <div id="alertGraph"
                            style="background-image: linear-gradient(rgb(164, 211, 238), rgb(245, 245, 243));">
                            <div id="legend" class="legend"></div>
                            <br>
                            <svg width="390" height="210" id="chart"></svg>
                          </div>
                          <div class="loader" style="width:410px;height:220px;padding-top:10px">
                            <div class="spinner">
                              <div class="double-bounce1"></div>
                              <div class="double-bounce2"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="box box-success">
                    <div class="box-header with-border headerStyle">
                      <h3 class="box-title">CO, CO2 and NO2 chart(ppm)</h3>
                    </div>
                    <div class="box-body no-padding">
                      <div class="row">
                        <div class="col-md-12">
                          <div id="alertGraph1"
                            style="background-image: linear-gradient(rgb(255, 253, 147), rgb(245, 245, 243));">
                            <div id="legend1" class="legend1"></div>
                            <br>
                            <svg width="390" height="210" id="chartEmission"></svg>
                          </div>
                          <div class="loader" style="width:410px;height:220px;padding-top:10px">
                            <div class="spinner">
                              <div class="double-bounce1"></div>
                              <div class="double-bounce2"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
  
                </div>
              </div>
            <div class="row">
                <div class="col-md-12"><a href="#" class="btn btn-sq-sm btn-success">
                    <img src="images/keep-nature-green.jpg" width="100%">

                   
                  </a></div>
            </div>

          </div>

          <div class="col-md-4">

            <div class="box box-default">
              <div class="box-header with-border headerStyle">
                <h3 class="box-title">Sensor Details</h3>

              </div>
              <div class="box-body">
                <div class="row">
                  <div class="col-md-12">

                    <div class="row">
                      <div class="col-xs-12 col-sm-4 center">
                        <span class="profile-picture">
                          <img class="editable img-responsive" alt=" Avatar" id="avatar" src="/images/Sensor.png">
                        </span>
                        <div class="space space-5"></div>

                        <a href="#" class="btn btn-sm btn-block btn-primary">
                          Stop Sensor
                        </a>
                      </div>
                      <div class="col-xs-12 col-sm-8">
                        <h4 class="blue">
                          <span class="middle hTitle">Sensor Node 1</span>

                        </h4>
                        <div class="profile-user-info">
                          <div class="profile-info-row">
                            <div class="profile-info-name "> Sensor IP Address </div>
                            <div class="profile-info-value">
                              <span class="userName">10.252.13.1</span>
                            </div>
                          </div>


                          <div class="profile-info-row">
                            <div class="profile-info-name"> Broadcast IP</div>
                            <div class="profile-info-value">
                              <span id="joinedOn">10.252.12.255</span>
                            </div>
                          </div>
                          <div class="profile-info-row">
                            <div class="profile-info-name"> IP Method </div>
                            <div class="profile-info-value">
                              <span id="vehicleNo">Static</span>
                            </div>
                          </div>
                        </div>
                        <div class="hr hr-8 dotted"></div>

                      </div>
                    </div>

                  </div>

                </div>

                <div class="box-footer no-padding">

                </div>
              </div>
            </div>
            <div class="box box-primary">
              <div class="box-header with-border headerStyle">
                <h3 class="box-title">Meter chart</h3>
              </div>

              <div class="box-body">
                <div class="row">
                  <div class="col-md-12">

                    <div class="direct-chat-messages">
                      <div class="Chart">

                        <div id="chart_div"></div>


                      </div>


                      <div class="loader">
                        <div class="spinner">
                          <div class="double-bounce1"></div>
                          <div class="double-bounce2"></div>
                        </div>
                      </div>
                    </div>
                     <hr>
                    <div class="row">

                      <div class="col-md-4"><a href="#" class="btn btn-sq-sm btn-warning">
                          <img src="images/sensor-icon.png" width="100%"><br />
                          CO(ppm): <span id="coindex">12</span>
                        </a></div>
                      <div class="col-md-4"><a href="#" class="btn btn-sq-sm btn-success">
                          <img src="images/sensor-icon.png" width="100%"><br />
                          CO2(ppm): <span id="co2index">12</span>
                        </a></div>
                      <div class="col-md-4"><a href="#" class="btn btn-sq-sm btn-primary">
                          <img src="images/sensor-icon.png" width="100%"><br />
                          NO2(ppm): <span id="no2index">12</span>
                        </a></div>

                    </div> 


                  </div>


                </div>


                <div class="box-footer no-padding">


                </div>
              </div>
            </div>

            <div class="box box-primary">
              <div class="box-header with-border headerStyle">
                <h3 class="box-title">Alert Chart</h3>
              </div>

              <div class="box-body">
                <div class="row">
                  <div class="col-md-12">

                    <div class="table-responsive" style="overflow-x: hidden; ">
                      <table class="table no-margin" id="alertChart" style="font-size: 12px">
                        <thead>
                          <tr>
                            <th>Type</th>
                            <th>Value</th>
                            <th>Threashold</th>
                            <th>Status</th>
                          </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Air Quality Index(AQI)
                                </td>
                                <td id='rSpeed'></td>
                                <td>
                                  0-50
                                </td>
                                <td><span class="label label-danger" id="sStatus">Moderate</span></td>
                              </tr>
                          <tr>
                            <td>Humidity(%)
                            </td>
                            <td id='rHumid'></td>
                            <td>
                              10-20
                            </td>
                            <td><span class="label label-success" id="hStatus">Moderate</span></td>
                          </tr>
                          <tr>
                            <td>Temperature(C)
                            </td>
                            <td id='rTemp'> </td>

                            <td>
                              25-35
                            </td>
                            <td><span class="label label-warning" id="tStatus">Moderate</span></td>
                          </tr>
                          <tr>
                              <td>CO
                              </td>
                              <td id='rCO'> </td>
  
                              <td>
                                13-20
                              </td>
                              <td><span class="label label-warning" id="coStatus">Moderate</span></td>
                            </tr>
                            <tr>
                                <td>C02
                                </td>
                                <td id='rCO2'> </td>
    
                                <td>
                                 300-340
                                </td>
                                <td><span class="label label-warning" id="co2Status">Moderate</span></td>
                              </tr>
                              <tr>
                                  <td>N02
                                  </td>
                                  <td id='rNO2'> </td>
      
                                  <td>
                                    60-70
                                  </td>
                                  <td><span class="label label-warning" id="no2Status">Moderate</span></td>
                                </tr>

                        </tbody>
                      </table>
                      <div class="loader" style="height: 200px;">
                        <div class="spinner">
                          <div class="double-bounce1"></div>
                          <div class="double-bounce2"></div>
                        </div>
                      </div>


                    </div>


                  </div>

                </div>

                <div class="box-footer no-padding">

                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <input type="hidden" id="vehicleId" value="1">
    </div>

    <footer class="main-footer">
      <div class="pull-right hidden-xs">
        <b>Version</b> 1.0.0
      </div>
      <strong>Copyright © 2018-2019 Real time tracking All rights
        reserved.
    </footer>

  </div>
  <!-- ./wrapper -->

  <!-- jQuery 3 -->
  <script src="./assets/jquery.min.js"></script>
  <!-- Bootstrap 3.3.7 -->
  <script src="./assets/bootstrap.min.js"></script>
  <!-- FastClick -->
  <script src="./assets/fastclick.js"></script>
  <!-- AdminLTE App -->
  <script src="./assets/adminlte.min.js"></script>
  <!-- Sparkline -->
  <script src="./assets/jquery.sparkline.min.js"></script>
  <!-- jvectormap  -->
  <script src="./assets/jquery-jvectormap-1.2.2.min.js"></script>
  <script src="./assets/jquery-jvectormap-world-mill-en.js"></script>
  <!-- SlimScroll -->
  <script src="./assets/jquery.slimscroll.min.js"></script>
  <!-- ChartJS -->
  <script src="./assets/Chart.js"></script>
  <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
  <script src="./assets/dashboard2.js"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="./assets/demo.js"></script>
  <script src="./js/commonScript.js"></script>
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARuNST-7vkHRPD_oKFFxlo937apF1v4Ls"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script src="//cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
  <script src="vertxbus.js"></script>
  <script>
    google.charts.load('current', {
      'packages': ['gauge']
    });
    google.charts.setOnLoadCallback(drawChart);

    // mean and deviation for time interval
    var meanMs = 1000, // milliseconds
      dev = 150;
    var url = window.location.href
    var arr = url.split("/");
    var domainAddress = arr[0] + "//" + arr[2];
    $('#avatar').attr('src', domainAddress + '/images/Sensor.png');


    var time_frame = 10000;
    var sChartHeight = 150;
    var sChartWidth = 360;
    var marginSpeed = 20;
    var duration = 1000;
    var time = Date.now() + duration;
    var start_time = time - (duration * 2) - time_frame;

    //var eb = new vertx.EventBus("http://35.209.112.128/" + "eventbus"); 
    var eb = new vertx.EventBus("http://eco-hat-amosds-aws-01-ecohat.apps02-london.amosdemo.io/" + "eventbus");
    var delay = 1000;
    initializeMap();

    // start the data generator

    var data = [];
    var sData = [];
    // var data = [100, 150, 200, 250, 280, 300];
    /*  var data = [ {creatTime: 0, cpuTime: 00}, {creatTime: 1, cpuTime: 30}, {creatTime: 2, cpuTime: 40},
         {creatTime: 3, cpuTime: 20}, {creatTime: 4, cpuTime: 90}, {creatTime: 5, cpuTime: 70} ]; */
    var margin = {
        top: 20,
        right: 20,
        bottom: 30,
        left: 50
      },
      width = 350 - margin.left - margin.right,
      height = 150 - margin.top - margin.bottom;



    var xScaleSpeed = d3.scaleTime()
      .domain([time + duration, time - (duration * 2) - time_frame])
      //    .domain([time - duration, start_time + duration])
      .range([sChartWidth - (marginSpeed * 2), 0]);

    var yScaleSpeed = d3.scaleLinear()
      .domain([0, 50])
      .range([sChartHeight - (marginSpeed * 2), 0]);

    var xAxis = d3.axisBottom(xScaleSpeed)
      .ticks(4);

    var yAxis = d3.axisRight(yScaleSpeed)
      .ticks(4);


    var svg = d3.select("#chart"),
      margin = {
        top: 5,
        right: 5,
        bottom: 50,
        left: 30
      },
      width = Math.floor(svg.attr("width") - margin.left - margin.right),
      height = Math.floor(svg.attr("height") - margin.top - margin.bottom);

    var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    g.append("defs").append("clipPath")
      .attr("id", "clip2")
      .append("rect")
      .attr("x", 0)
      .attr("y", 0)
      .attr("width", width)
      .attr("height", height);

    var parseTime = d3.timeParse("%Y%m%d");


    var svgE = d3.select("#chartEmission"),
      marginE = {
        top: 5,
        right: 5,
        bottom: 50,
        left: 30
      },
      widthE = Math.floor(svgE.attr("width") - marginE.left - marginE.right),
      heightE = Math.floor(svgE.attr("height") - marginE.top - marginE.bottom);

    var gE = svgE.append("g").attr("transform", "translate(" + marginE.left + "," + marginE.top + ")");

    gE.append("defs").append("clipPath")
      .attr("id", "clip2")
      .append("rect")
      .attr("x", 0)
      .attr("y", 0)
      .attr("width", widthE)
      .attr("height", heightE);


    var x1 = d3.scaleTime().range([0, width]),
      y1 = d3.scaleLinear().range([height, 0]),
      z1 = d3.scaleOrdinal(d3.schemeCategory10);

    y1.domain([0, 100]);



    var x1E = d3.scaleTime().range([0, widthE]),
      y1E = d3.scaleLinear().range([heightE, 0]),
      z1E = d3.scaleOrdinal(d3.schemeCategory10);

    y1E.domain([0, 370]);


    let dta = [{
        id: "AQI",
        values: []
      },
      {
        id: "Temperature(C)",
        values: []
      },
      {
        id: "Humidity(%)",
        values: []
      }

    ];

    let dtaE = [{
        id: "CO(ppm)",
        values: []
      },
      {
        id: "CO2(ppm)",
        values: []
      },
      {
        id: "NO2(ppm)",
        values: []
      }


    ];
    z1.domain(dta.map(function (c) {
      return c.id;
    }));
    z1E.domain(dtaE.map(function (c) {
      return c.id;
    }));

    var x_axis = d3.axisBottom()
      .scale(x1);
    var x_axis_svg = g.append("g")
      .attr("class", "axis axis--x")
      .attr("transform", "translate(0," + height + ")")
      .text("time(s)");

    x_axis_svg.call(x_axis);

    g.append("g")
      .attr("class", "axis axis--y")
      .call(d3.axisLeft(y1))
      .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", "0.71em")
      .attr("fill", "#000")
      .text("");

    var x_axisE = d3.axisBottom()
      .scale(x1E);
    var x_axis_svgE = gE.append("g")
      .attr("class", "axis axis--x")
      .attr("transform", "translate(0," + heightE + ")")
      .text("time(s)");

    x_axis_svgE.call(x_axisE);

    gE.append("g")
      .attr("class", "axis axis--y")
      .call(d3.axisLeft(y1E))
      .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", "0.71em")
      .attr("fill", "#000")
      .text("");

    let pathsG = g.append("g").attr("id", "paths").attr("class", "paths")
      .attr("clip-path", "url(#clip2)");


    let pathsGE = gE.append("g").attr("id", "paths").attr("class", "paths")
      .attr("clip-path", "url(#clip2)");


    let globalX = 0;
    //let duration = 1000; //how quickly to move (will look jerky if less that data input rate)
    let limit = 60; // how many datapoints, total points = (duration * limit)


    var chart, dataTable, options;

    //chart.draw(dataTable, options);

    eb.onopen = function () {
      // chart = new google.visualization.Gauge(document.getElementById('chart_div'));




      eb.registerHandler('loadVehicle', function (msg) {

        //console.log(data);
        if (data.length === 25) {
          // when length of data equal 25 then pop data[0]
          data.shift();
        }
        data.push({
          "eventTime": new Date(msg.eventTime),
          "vehicleHeat": msg.vehicleHeat,
          "vehicleHumidity": msg.vehicleHumidity,
          "vehicleSpeed": msg.vehicleSpeed,
          "vehicleId": msg.vehicleId,
          "vehicleCO": msg.vehicleCO,
          "vehicleCO2": msg.vehicleCO2,
          "vehicleNO2": msg.vehicleNO2

        });

        if (msg.vehicleId == $('#vehicleId').val()) {


          dataTable.setValue(0, 1, msg.vehicleSpeed);
          chart.draw(dataTable, options);

          dataTable.setValue(1, 1, msg.vehicleHeat);
          chart.draw(dataTable, options);

          dataTable.setValue(2, 1, msg.vehicleHumidity);
          chart.draw(dataTable, options);

          $('#rSpeed').html(msg.vehicleSpeed);

          $('#coindex').html(msg.vehicleCO);
          $('#co2index').html(msg.vehicleCO2);
          $('#aqiindex').html(msg.vehicleSpeed);

          
          $('#no2index').html(msg.vehicleNO2);

          $('#sStatus').removeClass('label-success');
          $('#sStatus').removeClass('label-danger');

          $('#hStatus').removeClass('label-success');
          $('#hStatus').removeClass('label-danger');

          $('#tStatus').removeClass('label-success');
          $('#tStatus').removeClass('label-danger');
          $('#aqiStatus').removeClass('label-success');
          $('#aqiStatus').removeClass('label-danger');

          if (inRange(msg.vehicleSpeed, 0, 50)) {
            $('#sStatus').addClass('label-success').html("Good");
            $('#aqiStatus').addClass('label-success').html("Good");
            
          } else if(inRange(msg.vehicleSpeed, 51, 100)) { 
            $('#sStatus').addClass('label-warning').html("Moderate");
            $('#aqiStatus').addClass('label-warning').html("Moderate");

          }
          else {
            $('#sStatus').addClass('label-danger').html("Unhealthy");
            $('#aqiStatus').addClass('label-danger').html("Unhealthy");
            
          }
          

          if (inRange(msg.vehicleHumidity, 10, 20)) {
            $('#hStatus').addClass('label-success').html("Good");

          } else {
            $('#hStatus').addClass('label-danger').html("Unhealthy");
          }

          if (inRange(msg.vehicleHeat, 25, 35)) {
            $('#tStatus').addClass('label-success').html("Good");
          } else {
            $('#tStatus').addClass('label-danger').html("Unhealthy");
          }

          if (inRange(msg.vehicleCO, 13, 20)) {
            $('#tStatus').addClass('label-success').html("Good");
          } else {
            $('#tStatus').addClass('label-danger').html("Unhealthy");
          }

          if (inRange(msg.vehicleCO2, 300, 340)) {
            $('#tStatus').addClass('label-success').html("Good");
          } else {
            $('#tStatus').addClass('label-danger').html("Unhealthy");
          }

          if (inRange(msg.vehicleNO2, 60, 70)) {
            $('#tStatus').addClass('label-success').html("Good");
          } else {
            $('#tStatus').addClass('label-danger').html("Unhealthy");
          }


          $('#rHumid').html(msg.vehicleHumidity);
          $('#rTemp').html(msg.vehicleHeat);

          $('#rCO').html(msg.vehicleCO);
          $('#rCO2').html(msg.vehicleCO2);
          $('#rNO2').html(msg.vehicleNO2);


          updateChart(msg);
          updateChartE(msg);
          //updateHumidity(msg);
        }
      });

    };

    function drawChart() {

      chart = new google.visualization.Gauge(document.getElementById('chart_div'));


      dataTable = google.visualization.arrayToDataTable([
        ['Label', 'Value'],
        ['AQI', 80],
        ['Temp', 55],
        ['Humidity', 68]
      ]);

      options = {
        width: 400,
        height: 120,
        redFrom: 80,
        redTo: 100,
        yellowFrom: 60,
        yellowTo: 80,
        minorTicks: 5
      };


    }
  </script>
</body>

</html>
